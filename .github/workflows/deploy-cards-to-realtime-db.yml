name: Sync Cards to Firebase Database Only

on:
  workflow_dispatch:
  push:
    paths:
      - 'cards/*.json'
      - '.github/workflows/deploy-cards-to-realtime-db.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ”§ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: ðŸ” Upload JSON to Firebase Realtime Database
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          for file in cards/*.json; do
            key=$(basename "$file" .json)
            echo "â†’ Uploading $file to /cards/$key"
            firebase database:set /cards/$key "$file" \
              --project nft-cards-1cd82 \
              --token "$FIREBASE_TOKEN"
          done

      - name: ðŸ§¹ Auto-delete removed card metadata
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase database:get /cards \
            --project nft-cards-1cd82 \
            --token "$FIREBASE_TOKEN" > allCards.json

          for key in $(jq -r 'keys[]' allCards.json); do
            if [ ! -f "cards/$key.json" ]; then
              echo "â†’ Deleting /cards/$key (missing from GitHub)"
              firebase database:remove /cards/$key \
                --project nft-cards-1cd82 \
                --token "$FIREBASE_TOKEN"
            fi
          done

