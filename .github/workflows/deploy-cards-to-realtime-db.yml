name: Sync Cards to Firebase (JSON + Images)

on:
  workflow_dispatch:
  push:
    paths:
      - 'cards/**'
      - '.github/workflows/deploy-cards-to-firebase.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üìÇ Checkout Repository
        uses: actions/checkout@v3

      - name: üîß Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: üì¶ Install Firebase CLI
        run: npm install -g firebase-tools

      - name: üîÅ Sync JSON to Realtime Database
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Uploading all JSON to Realtime DB..."
          for file in cards/*.json; do
            key=$(basename "$file" .json)
            echo "‚Üí Uploading $file to /cards/$key"
            firebase database:set /cards/$key "$file" \
              --project nft-cards-1cd82 \
              --token "$FIREBASE_TOKEN"
          done

      - name: üóëÔ∏è Clean up deleted JSON from Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Finding deleted keys..."
          firebase database:get /cards \
            --project nft-cards-1cd82 \
            --token "$FIREBASE_TOKEN" > allCards.json

          for key in $(jq -r 'keys[]' allCards.json); do
            if [ ! -f "cards/$key.json" ]; then
              echo "‚Üí Deleting /cards/$key"
              firebase database:remove /cards/$key \
                --project nft-cards-1cd82 \
                --token "$FIREBASE_TOKEN"
            fi
          done

      - name: ‚òÅÔ∏è Upload PNG images to Firebase Storage
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Uploading card images..."
          for file in cards/*.png; do
            name=$(basename "$file")
            echo "‚Üí Uploading $name to /card-images/"
            firebase storage:upload "$file" \
              --path "/card-images/$name" \
              --project nft-cards-1cd82 \
              --token "$FIREBASE_TOKEN"
          done
